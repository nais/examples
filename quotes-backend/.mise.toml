[tools]
java = "21"
gradle = "latest"

[env]
GRADLE_OPTS = "-Dorg.gradle.daemon=true -Dorg.gradle.parallel=true"
JAVA_TOOL_OPTIONS = "-XX:+UseG1GC"
DB_URL = "jdbc:postgresql://localhost:5433/quotes"
DB_USERNAME = "quotes"
DB_PASSWORD = "quotes"

[tasks.dev]
description = "Start development server with auto-reload"
run = "./gradlew run --continuous"

[tasks.build]
description = "Build the Kotlin application"
run = "./gradlew build"

[tasks.test]
description = "Run all tests"
run = "./gradlew test"

[tasks.run]
description = "Run the application"
run = "./gradlew run"

[tasks.watch]
description = "Run the application with hot reload (alias for dev)"
run = "./gradlew run --continuous"

[tasks.clean]
description = "Clean build artifacts"
run = "./gradlew clean"

[tasks.check]
description = "Run all checks (tests, linting, etc.)"
run = "./gradlew check"

[tasks.dependencies]
description = "Show dependency updates"
run = "./gradlew dependencyUpdates"

[tasks.lint]
description = "Run Kotlin linting (using check task)"
run = "./gradlew check"

[tasks.format]
description = "Format Kotlin code"
run = "./gradlew ktlintFormat"

[tasks.format-check]
description = "Check Kotlin code formatting"
run = "./gradlew ktlintCheck"

[tasks.docker-build]
description = "Build Docker image"
run = "docker build -t quotes-backend:local ."

[tasks.docker-run]
description = "Run Docker container locally"
run = "docker run -p 8080:8080 quotes-backend:local"

[tasks.ci]
description = "Run all CI checks"
run = ["./gradlew clean", "./gradlew check", "./gradlew build"]

[tasks."dependencies:check"]
description = "Check for outdated dependencies"
run = "./gradlew dependencyUpdates"

[tasks."dependencies:update"]
description = "Check for outdated dependencies (Gradle requires manual updates)"
run = "./gradlew dependencyUpdates"
[tasks."db:start"]
description = "Start local PostgreSQL database"
run = [
  "echo 'üóÑÔ∏è Starting quotes database...'",
  "docker-compose -f ../docker-compose.yaml up -d quotes-db",
  "echo 'Waiting for database to be ready...'",
  "for i in {1..30}; do nc -z localhost 5433 2>/dev/null && echo '‚úÖ Database ready on localhost:5433' && break || sleep 1; done",
]

[tasks."db:stop"]
description = "Stop local PostgreSQL database"
run = [
  "echo 'üõë Stopping quotes database...'",
  "docker-compose -f ../docker-compose.yaml stop quotes-db",
]

[tasks."db:logs"]
description = "Show database logs"
run = "docker-compose -f ../docker-compose.yaml logs -f quotes-db"

[tasks."db:psql"]
description = "Connect to database with psql"
run = "docker exec -it nais-quotes-quotes-db-1 psql -U quotes -d quotes"

[tasks."db:reset"]
description = "Reset database (WARNING: destroys all data)"
run = [
  "echo '‚ö†Ô∏è This will destroy all database data!'",
  "read -p 'Are you sure? (yes/no): ' confirm",
  "if [ \"$confirm\" = \"yes\" ]; then",
  "  docker-compose -f ../docker-compose.yaml down -v quotes-db",
  "  docker-compose -f ../docker-compose.yaml up -d quotes-db",
  "  echo '‚úÖ Database reset complete'",
  "else",
  "  echo '‚ùå Reset cancelled'",
  "fi",
]

[tasks."dev:with-db"]
description = "Start database and development server"
run = [
  "mise run db:start",
  "echo 'üöÄ Starting development server...'",
  "./gradlew run --continuous",
]
